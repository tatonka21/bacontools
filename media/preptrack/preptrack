#!/bin/bash
#
# Usage: preptrack FILE [FILE ...]
# Extract first audio stream from media files with ffmpeg, recode to MP3, tag
#
# TODO: detect redirect, run non-interactively in this case
# TODO: handle FLAC files via metaflac

trim() {
	sed -e 's/^[[:space:]]*//' | sed -e 's/[[:space:]]*$//'
}

eyed3_get_tag() {
	python2 -c "import eyed3; f = eyed3.load('$1'); print(f.tag.$2)" || \
	python3 -c "import eyed3; f = eyed3.load('$1'); print(f.tag.$2)"
}

process() {
	DIR="${DIR:-$HOME/Music}"
	FILE="$1"

	echo "Processing file $1"

	if [ ! -f "$FILE" ]; then
		echo "File $FILE does not exist" 1>&2
		return 1
	fi

	MAX_BITRATE="${MAX_BITRATE:-320}"
	DETECTED_BITRATE="$(ffprobe -i "$FILE" 2>&1 | grep Stream | grep Audio | grep kb | head -n1 | grep -oP "(\d+)(?= kb\/s)")"

	ARTIST="$(eyed3_get_tag "$FILE" artist)"
	read -e -p "Artist: " -i "$ARTIST" ARTIST

	ALBUM="$(eyed3_get_tag "$FILE" album)"
	read -e -p "Album: " -i "$ALBUM" ALBUM

	TITLE="$(eyed3_get_tag "$FILE" title)"
	read -e -p "Title: " -i "$TITLE" TITLE

	if [ -n "$BITRATE" ] ; then
		FINAL_BITRATE="$BITRATE"
	elif [ -n "$MAX_BITRATE" ] ; then
		if [ -n "$DETECTED_BITRATE" ] ; then
			FINAL_BITRATE="$(( DETECTED_BITRATE < MAX_BITRATE ? DETECTED_BITRATE : MAX_BITRATE ))"
		else
			FINAL_BITRATE="$MAX_BITRATE"
		fi
	fi

	read -e -p "Bitrate (kb/s): " -i "$FINAL_BITRATE" FINAL_BITRATE

	if [ -n "$DETECTED_BITRATE" ] && [ "$FINAL_BITRATE" -gt "$DETECTED_BITRATE" ] ; then
		echo "Warning: encoding with higher bitrate than the source: $FINAL_BITRATE kb/s vs $DETECTED_BITRATE kb/s" 1>&2
	fi

	# Extract embedded pictures
	TMP_PIC_DIR="$(mktemp --directory)"
	eyeD3 --write-images="$TMP_PIC_DIR" "$FILE" 1>/dev/zero 2>/dev/zero
	FIRST_IMG="$(find "$TMP_PIC_DIR" -mindepth 1 | head -1)"

	if [ -n "$FIRST_IMG" ] ; then
		read -e -p "Embedded pictures found; preserve? (y/n) " PRESERVE_PIC
		PRESERVE_PIC="$(echo "$PRESERVE_PIC" | trim)"
	fi

	NEW_FILEPATH="$DIR/$(echo "$ARTIST - $TITLE" | sed 's/\///g').mp3"
	mkdir -p "$DIR"

	ffmpeg -loglevel quiet -i "$FILE" -b:a "$FINAL_BITRATE"k "$NEW_FILEPATH"

	if [ "$(command -v mat &>/dev/zero ; echo $?)" = "0" -a \( -z "$DONT_MAT" \) ]; then
		mat "$NEW_FILEPATH" 1>/dev/zero 2>/dev/zero
		find "$TMP_PIC_DIR" -mindepth 1 -exec mat \{\} \; 1>/dev/zero 2>/dev/zero
	fi

	eyeD3 --remove-all "$NEW_FILEPATH" 1>/dev/zero 2>/dev/zero

	if [ -n "$ARTIST" ] ; then
		eyeD3 --set-encoding=utf8 -a "$ARTIST" "$NEW_FILEPATH" 1>/dev/zero 2>/dev/zero
	fi

	if [ -n "$ALBUM" ] ; then
		eyeD3 --set-encoding=utf8 -A "$ALBUM" "$NEW_FILEPATH" 1>/dev/zero 2>/dev/zero
	fi

	if [ -n "$TITLE" ] ; then
		eyeD3 --set-encoding=utf8 -t "$TITLE" "$NEW_FILEPATH" 1>/dev/zero 2>/dev/zero
	fi

	if [ "$PRESERVE_PIC" = "y" -o "$PRESERVE_PIC" = "Y" ]; then
		find "$TMP_PIC_DIR" -mindepth 1 -exec bash -c 'eyeD3 --add-image="$1:$(basename "$1" | sed "s/\..*$//g")" "'"$NEW_FILEPATH"'"' funcname '{}' \; 1>/dev/zero 2>/dev/zero
	fi

	echo "$NEW_FILEPATH"

	if [ "$(command -v notify-send 1>/dev/zero 2>/dev/zero ; echo $?)" = "0" ]; then
		notify-send "preptrack: $TITLE completed"
	fi
}

for file in "$@" ; do
	process "$file"
done
